'use client';

import { useEffect, useRef } from 'react';
import { motion } from 'framer-motion';
import { DynamicLayout } from '@/components/DynamicLayout';
import { SkeletonLoader } from '@/components/SkeletonLoader';
import { useLayoutContext } from '@/context/LayoutContext';
import { CONTENT } from '@/lib/dictionary';

export default function Home() {
  const { layout, loading, isGenerating } = useLayoutContext();
  const contentRef = useRef<HTMLDivElement>(null);

  // Track generation state
  const isInitialGeneration = useRef(true);

  // Trigger scroll on Start of Generation (Rising Edge)
  useEffect(() => {
    if (isGenerating) {
      if (isInitialGeneration.current) {
        // First load - Do NOT scroll
        isInitialGeneration.current = false;
      } else {
        // Subsequent generation - Scroll to main content area immediately
        // We use window height because the Hero is min-h-screen
        window.scrollTo({
          top: window.innerHeight,
          behavior: 'smooth'
        });
      }
    }
  }, [isGenerating]);

  // If loading and NO layout, show full screen skeleton. 
  // If we have a layout but are regenerating, we might want to just show the spinner in the input (handled by GlobalInput)
  if (loading && !layout) {
    return <SkeletonLoader />;
  }

  if (!layout) {
    return <div className="text-center p-10">Failed to load content.</div>;
  }

  // Handle "Finished but Empty"
  if (!loading && !isGenerating && layout.layout?.length === 0) {
    return <div className="text-center p-10 text-slate-500">No content generated. Try again?</div>;
  }

  return (
    <main className="relative">
      <motion.div
        ref={contentRef}
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.5, ease: "easeOut" }}
        className="pt-20"
      >
        <DynamicLayout layout={layout} />

        {/* AI Disclaimer */}
        <div className="text-center p-4 pb-8 opacity-60 hover:opacity-100 transition-opacity">
          <p className="text-xs text-slate-500">
            {CONTENT.global.downloadCV ? ( /* Fallback safe check or direct usage */
              <>
                {CONTENT.generative.aiDisclaimer}
                <a href="/resume/johnpino_resume.pdf" target="_blank" className="underline hover:text-accent-pink transition-colors" download>
                  {CONTENT.generative.aiDisclaimerLink}
                </a>
              </>
            ) : (
              "Content generated by AI."
            )}
          </p>
        </div>
      </motion.div>
    </main>
  );
}
